#!/usr/bin/env node

const path = require('path')
const fs = require('fs')
const readline = require('readline');
const { execSync } = require('child_process');
const Config = require('../lib/utils/config')

const ContentDefault = {
  scripts: { test: "pagewalker" },
  dependencies: { pagewalker: "*" }
};

function getStdin(message) {
  const rl = readline.createInterface({ input: process.stdin, output: process.stdout });
  return new Promise((resolve, _) => {
    rl.question(message, (answer) => {
      resolve(answer);
      rl.close();
    });
  });
}
// the dir where we're doin stuff.
const dir = process.cwd()
const packageFile = path.resolve(dir, 'package.json')
const scenarioDir = path.resolve(dir, 'test');
const downloadDir = path.resolve(dir, 'downloads');

async function main() {

  let createPackageJson = true;
  if(fs.existsSync(packageFile)){
    let overwriteIt = await getStdin(` - "package.json" is found, overwrite it? (y/N)`);
    if (overwriteIt.trim().toUpperCase() == 'N') {
      createPackageJson = false;
    }
  }

  if (createPackageJson) {
    // npm init
    console.log(` - execute "npm init -y"`);
    execSync('npm init -y', { cwd: dir })
    console.log(` - Done successfully. "npm init -y"`);
  }

  if(!fs.existsSync(packageFile)){
    console.log(` - "package.json" is not found. Abort!`);
    process.exit(1);
  }

  let packageJsonText = fs.readFileSync(packageFile, 'utf-8');
  let jsonContent = null;
  try {
    jsonContent = JSON.parse(packageJsonText);
  } catch (e) {
    console.log(' - JSON parse error:', e);
    process.exit(1);
  }

  function copyContentDefault(obj, key) {
    if (!obj[key]) {
      obj[key] = {};
    }
    Object.assign(obj[key], ContentDefault[key]);
  }

  copyContentDefault(jsonContent, 'scripts');
  copyContentDefault(jsonContent, 'dependencies');

  fs.writeFileSync(packageFile, (JSON.stringify(jsonContent, null, 2) + '\n'), 'utf8');

  console.log(` - Done saving package.json. [${packageFile}]`)

  if(!fs.existsSync(scenarioDir)){
    fs.mkdirSync(scenarioDir);
    console.log(` - Done creating scenario directory. [${scenarioDir}]`)
  }

  if(!fs.existsSync(downloadDir)){
    fs.mkdirSync(downloadDir);
    console.log(` - Done creating downloads directory. [${downloadDir}]`)
  }

  // 01_sample_scenario.js
  const destFile = path.resolve(scenarioDir, '01_sample_scenario.js');
  let copySample = true;
  if(fs.existsSync(destFile)){
    overwriteIt = await getStdin(` - Sample scenario file["${destFile}"] is found, overwrite it? (y/N)`);
    if (overwriteIt.trim().toUpperCase() != 'Y') {
      copySample = false;
    }
  }
  if (copySample) {
    fs.copyFileSync(path.resolve(__dirname, '../example/01_sample_scenario.js'), destFile);
    console.log(` - Done saving Sample scenario file. [${destFile}]`);
  }

  // save config.json
  let configFile = path.resolve(dir, 'config.json');
  let saveConfig = true;
  if(fs.existsSync(configFile)){
    overwriteIt = await getStdin(` - Configuration file["${configFile}"] is found, overwrite it? (y/N)`);
    if (overwriteIt.trim().toUpperCase() != 'Y') {
      saveConfig = false;
    }
  }
  if (saveConfig) {
    fs.writeFileSync(configFile, (JSON.stringify(Config.DEFAULT_CONFIG, null, 2) + '\n'), 'utf8');
    console.log(` - Done createing configuration file. [${configFile}]`);
  }
}

console.log("Initializing pagewaler project....");

main()
.then(() => {
  console.log("Finished initializing pagewalker project.")
  console.log("Next, Please enter \n\t npm install\n\t npm test")
})
.catch((err) => {
  console.error("[ERROR] ", err);
  process.exit(1);
})
